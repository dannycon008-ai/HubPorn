<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ajustes HubPorn</title>

  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .panel {
      margin-top: 40px;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 14px;
      width: 95%;
      max-width: 650px;
      border: 1px solid #333;
      box-shadow: 0 8px 20px rgba(0,0,0,.5);
    }
    h1 {
      font-family: "Archivo Black", sans-serif;
      text-align: center;
      margin-bottom: 25px;
      font-size: 2rem;
      background: linear-gradient(to right, #ff4444, #ffa045);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    h3 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-weight: bold;
      color: #ffa045;
    }
    input, select, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
    }
    input, select, textarea {
      background: #2a2a2a;
      color: #fff;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background: #ff4444;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: .2s;
    }
    button:hover { background: #ff2222; }
    hr { border: 0; border-top: 1px solid #333; margin: 20px 0; }

    #deleteVideoList {
      display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;
    }
    #deleteVideoList div {
      width: 140px; background: #1b1b1b;
      border: 1px solid #333; border-radius: 8px;
      text-align: center; padding: 8px;
    }
    #deleteVideoList video {
      width: 120px; height: 70px; border-radius: 6px;
    }

    .poster-dropzone {
      margin-top:6px; padding:10px;
      border:2px dashed #444; border-radius:6px;
      text-align:center; color:#aaa; font-size:.9rem;
    }
    .poster-dropzone.dragover { border-color:#ff4444; color:#fff; }

    .stat-card {
      background:#2a2a2a;
      padding:12px;
      border-radius:8px;
      margin-top:20px;
      text-align:center;
    }
    .stat-card h3 { margin:0 0 8px; }
    .stat-card p { font-size:1.4rem; font-weight:bold; }
  </style>
</head>
<body>
  <div class="panel">
    <h1>📂 Panel de Admin</h1>

    <!-- Crear Carpeta -->
    <h3>➕ Crear Carpeta</h3>
    <input type="text" id="folderName" placeholder="Nombre de carpeta">
    <button onclick="addFolder()">Crear Carpeta</button>
    <hr>

    <!-- Agregar Videos -->
    <h3>🎬 Agregar Videos</h3>
    <textarea id="videoURLs" placeholder="Pega aquí varias URLs de videos (una por línea)"></textarea>
    <textarea id="posterURLs" placeholder="Pega aquí varias URLs de posters (una por línea, opcional, mismo orden que los videos)"></textarea>
 <div class="poster-dropzone" id="posterDrop">
  📷 Suelta o pega (Ctrl+V) imágenes aquí — o haz clic para buscar
</div>
<input type="file" id="posterInput" accept="image/*" multiple hidden>

    <select id="folderSelect"></select>
    <button onclick="addVideos()">Agregar Videos</button>
    <hr>

    <!-- Eliminar Carpeta -->
    <h3>🗑️ Eliminar Carpeta</h3>
    <select id="deleteFolderSelect"></select>
    <button onclick="deleteFolder()">Eliminar Carpeta</button>
    <hr>

    <!-- Eliminar Video -->
    <h3>🗑️ Eliminar Video</h3>
    <select id="deleteVideoFolderSelect" onchange="populateVideosToDelete()"></select>
    <div id="deleteVideoList"></div>

    <!-- Vistas -->
    <div class="stat-card">
      <h3>👁️ Visitas al sitio</h3>
      <p id="siteViewsCounter">0</p>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCvQcDPSF9u1mr2RNQClhMEQ1yDZiuLM-M",
      authDomain: "minitinder-f6314.firebaseapp.com",
      projectId: "minitinder-f6314",
      storageBucket: "minitinder-f6314.appspot.com",
      messagingSenderId: "659347167496",
      appId: "1:659347167496:web:a4e76f562ffba1c4bdf4bd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const folderSelect = document.getElementById("folderSelect");
    const deleteFolderSelect = document.getElementById("deleteFolderSelect");
    const deleteVideoFolderSelect = document.getElementById("deleteVideoFolderSelect");

    // Crear Carpeta
    async function addFolder(){
      const name = document.getElementById("folderName").value.trim();
      if (!name) return alert("Debes escribir un nombre.");
      await db.collection("folders").doc(name).set({ videos: [] });
      renderSidebar();
      document.getElementById("folderName").value = "";
      alert("Carpeta creada ✅");
    }
  // --- Referencias a elementos ---
  const posterDrop  = document.getElementById('posterDrop');
  const posterInput = document.getElementById('posterInput');

  // --- Efecto visual al arrastrar sobre la zona ---
  ['dragenter','dragover'].forEach(ev => {
    posterDrop.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation();
      posterDrop.classList.add('dragover');
    });
  });
  ['dragleave','dragend','drop'].forEach(ev => {
    posterDrop.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation();
      posterDrop.classList.remove('dragover');
    });
  });

  // --- Drop (soltar imágenes) ---
  posterDrop.addEventListener('drop', async e => {
    const files = [...(e.dataTransfer?.files || [])].filter(f => f.type.startsWith('image/'));
    if(!files.length){ posterDrop.textContent = 'No se detectaron imágenes…'; return; }

    posterDrop.textContent = 'Subiendo…';
    for(const f of files){
      const url = await uploadPosterFile(f);
      appendPosterURL(url);
    }
    posterDrop.textContent = `¡Listo! Añadidas ${files.length} imagen(es).`;
  });

  // --- Clic → abrir selector de archivos ---
  posterDrop.addEventListener('click', () => posterInput.click());

  posterInput.addEventListener('change', async e => {
    const files = [...e.target.files];
    if(!files.length) return;

    posterDrop.textContent = 'Subiendo…';
    for(const f of files){
      const url = await uploadPosterFile(f);
      appendPosterURL(url);
    }
    posterDrop.textContent = `¡Listo! Añadidas ${files.length} imagen(es).`;
    posterInput.value = ''; // limpia el input
  });

  // --- Pegar (Ctrl+V) cuando el foco está en la zona ---
  posterDrop.addEventListener('paste', async e => {
    const items = [...(e.clipboardData?.items || [])].filter(it => it.type.indexOf('image') === 0);
    if(!items.length) return;

    posterDrop.textContent = 'Subiendo…';
    for(const it of items){
      const file = it.getAsFile();
      const url = await uploadPosterFile(file);
      appendPosterURL(url);
    }
    posterDrop.textContent = 'Imagen(es) pegada(s) ✔';
  });

    
  // Sube un archivo a Storage y devuelve su URL pública
  async function uploadPosterFile(file){
    const safeName = file.name.replace(/\s+/g,'-').toLowerCase();
    const ref = storage.ref('posters/' + Date.now() + '-' + Math.random().toString(36).slice(2) + '-' + safeName);
    await ref.put(file);
    return await ref.getDownloadURL();
  }

  // Añade la URL al textarea de posters (una por línea)
  function appendPosterURL(url){
    const ta = document.getElementById('posterURLs');
    ta.value += (ta.value ? '\n' : '') + url;
  }

    // Agregar varios videos con poster opcional
    async function addVideos(){
      const urls = document.getElementById("videoURLs").value.trim().split("\n").map(u=>u.trim()).filter(u=>u);
      const posters = document.getElementById("posterURLs").value.trim().split("\n").map(u=>u.trim());
      const folder = folderSelect.value;
      if (!urls.length || !folder) return alert("Debes pegar URLs y seleccionar carpeta.");

      const folderRef = db.collection("folders").doc(folder);
      const folderDoc = await folderRef.get();
      const data = folderDoc.exists ? folderDoc.data() : {videos:[]};
      const videos = data.videos || [];

      urls.forEach((url, i)=>{
        videos.push({
          url,
          poster: posters[i] || url + "#t=5",
          views: 0,
          reactions: { like:0, dislike:0 },
          userReaction: null,
          comments: []
        });
      });

      await folderRef.set({ videos });
      document.getElementById("videoURLs").value = "";
      document.getElementById("posterURLs").value = "";
      alert("Videos agregados ✅");
    }

    // Pegar imagen desde portapapeles
    document.getElementById("pasteDropzone").addEventListener("paste", async (e)=>{
      const items = e.clipboardData.items;
      for(let i=0;i<items.length;i++){
        if(items[i].type.indexOf("image")===0){
          const file = items[i].getAsFile();
          const ref = storage.ref("posters/" + Date.now() + ".jpg");
          await ref.put(file);
          const url = await ref.getDownloadURL();
          document.getElementById("posterURLs").value += (document.getElementById("posterURLs").value?"\n":"") + url;
          document.getElementById("pasteDropzone").textContent = "Imagen subida ✔";
        }
      }
    });

    // Eliminar Carpeta
    async function deleteFolder(){
      const folder = deleteFolderSelect.value;
      if (!folder) return;
      if (confirm(`¿Eliminar carpeta "${folder}" con todos sus videos?`)) {
        await db.collection("folders").doc(folder).delete();
        renderSidebar();
        alert("Carpeta eliminada ✅");
      }
    }

    // Mostrar videos a eliminar
    async function populateVideosToDelete(){
      const folder = deleteVideoFolderSelect.value;
      const container = document.getElementById("deleteVideoList");
      container.innerHTML = "";
      if (!folder) return;

      const docSnap = await db.collection("folders").doc(folder).get();
      if (docSnap.exists){
        docSnap.data().videos.forEach((v, idx)=>{
          const div = document.createElement("div");
          div.innerHTML = `
            <video src="${v.url}" muted></video>
            <p>Video ${idx+1}</p>
            <button onclick="deleteVideo('${folder}',${idx})">Eliminar</button>
          `;
          container.appendChild(div);
        });
      }
    }

    async function deleteVideo(folder, idx){
      if (!folder) return;
      const docSnap = await db.collection("folders").doc(folder).get();
      if (!docSnap.exists) return;
      const data = docSnap.data();
      data.videos.splice(idx,1);
      await db.collection("folders").doc(folder).update({videos:data.videos});
      populateVideosToDelete();
    }

    async function renderSidebar(){
      folderSelect.innerHTML = "";
      deleteFolderSelect.innerHTML = "";
      deleteVideoFolderSelect.innerHTML = "";
      const snapshot = await db.collection("folders").get();
      snapshot.forEach(doc=>{
        [folderSelect, deleteFolderSelect, deleteVideoFolderSelect].forEach(sel=>{
          const opt=document.createElement("option");
          opt.value=doc.id; opt.textContent=doc.id;
          sel.appendChild(opt);
        });
      });
    }

    // Contador de visitas (arranca en 4025)
    async function incrementSiteViews(){
      const ref = db.collection("stats").doc("siteViews");
      const snap = await ref.get();
      if(snap.exists){
        await ref.update({ count: (snap.data().count||0) + 1 });
      } else {
        await ref.set({ count: 4025 });
      }
    }
    async function renderSiteViews(){
      const snap = await db.collection("stats").doc("siteViews").get();
      document.getElementById("siteViewsCounter").textContent = snap.exists ? snap.data().count : 4025;
    }

    incrementSiteViews();
    renderSiteViews();
    renderSidebar();
  </script>
</body>
</html>
