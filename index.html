<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HubPorn</title>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Poppins:wght@500;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
  :root {
    --card:#1b1b1b;
    --accent:#ff4444;
  }
  body {
    background:#0d0d0d;
    color:#fff;
    font-family:'Poppins', sans-serif;
  }

  /* Ajuste de cards de carpetas */
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 15px;
  }
  .card {
    background: var(--card);
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: transform .2s ease, box-shadow .2s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,.35);
  }
  .card:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0,0,0,.45);
  }
  .card-thumb {
    width: 100%;
    height: 110px;
    object-fit: cover;
    display: block;
  }
  .card-title {
    font-size: 0.85rem;
    font-weight: 600;
    text-align: center;
    padding: 8px;
    color: #fff;
  }

  /* Reacciones */
  .reactions {
    margin: 12px 0;
    display: flex;
    justify-content: center;
    gap: 12px;
  }
  .reactions button {
    background: #222;
    border: none;
    padding: 8px 14px;
    border-radius: 20px;
    color: #fff;
    cursor: pointer;
    transition: .2s;
  }
  .reactions button.active {
    background: var(--accent);
  }
  .reactions button:hover {
    transform: scale(1.05);
  }
  </style>
</head>
<body>
  <h2 id="sectionTitle">üìÇ Todas las carpetas</h2>
  <div id="folderGrid" class="grid"></div>
  <div id="videoSection"></div>
  <div id="previewList"></div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyCvQcDPSF9u1mr2RNQClhMEQ1yDZiuLM-M",
      authDomain: "minitinder-f6314.firebaseapp.com",
      projectId: "minitinder-f6314",
      storageBucket: "minitinder-f6314.appspot.com",
      messagingSenderId: "659347167496",
      appId: "1:659347167496:web:a4e76f562ffba1c4bdf4bd"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const folderGrid   = document.getElementById("folderGrid");
    const previewList  = document.getElementById("previewList");
    const videoSection = document.getElementById("videoSection");
    const sectionTitle = document.getElementById("sectionTitle");

    function renderHome(docs){
      sectionTitle.textContent = "üìÇ Todas las carpetas";
      videoSection.innerHTML = "";
      folderGrid.style.display = "grid";

      if (!docs.length){
        folderGrid.innerHTML = "<p>No hay carpetas</p>";
        return;
      }

      folderGrid.innerHTML = docs.map(doc=>{
        const folder = doc.id;
        const data = doc.data(); 
        const videos = data.videos || [];
        const preview = videos[0]?.poster || videos[0]?.url || "";
        return `
          <div class="card" onclick="openFolder('${folder}')">
            ${preview ? `<video class="card-thumb" src="${preview}" muted playsinline></video>` 
                      : `<div style="height:110px;background:#222"></div>`}
            <div class="card-title">${folder}</div>
          </div>
        `;
      }).join("");
    }

    // Abrir carpeta
    async function openFolder(folder){
      const snap = await db.collection("folders").doc(folder).get();
      if (!snap.exists){ 
        sectionTitle.textContent = folder;
        folderGrid.innerHTML = "";
        videoSection.innerHTML = "<p>No hay videos</p>"; 
        return;
      }
      sectionTitle.textContent = folder;
      folderGrid.style.display = "none";

      const data = snap.data();
      videoSection.innerHTML = `
        <div class="grid">
          ${data.videos.map((v,idx)=>`
            <div class="card" onclick="playVideo('${folder}', ${idx})">
              <video class="card-thumb" src="${v.poster||v.url}" muted playsinline></video>
              <div class="card-title">Video ${idx+1}</div>
            </div>
          `).join("")}
        </div>
      `;
    }

    // Reproducir video
    async function playVideo(folder,idx){
      const ref=db.collection("folders").doc(folder);
      const snap=await ref.get(); if(!snap.exists) return;
      const data=snap.data(); const v=data.videos[idx];

      v.views=(v.views||0)+1; 
      data.videos[idx]=v; 
      await ref.update({videos:data.videos});

      sectionTitle.textContent=`‚ñ∂ ${folder}`;
      folderGrid.style.display="none";

      videoSection.innerHTML=`
        <div class="video-player">
          <video id="videoPlayer" controls autoplay width="300" height="350" poster="${v.poster||v.url}" controlsList="nodownload">
            <source src="${v.url}" type="video/mp4">
          </video>
          <p>üëÅÔ∏è ${v.views} vistas</p>
          <div class="reactions">
            <button id="likeBtn" onclick="toggleReaction('${folder}',${idx},'like')">
              üëç (<span id="likeCount">${v.reactions?.like||0}</span>)
            </button>
            <button id="dislikeBtn" onclick="toggleReaction('${folder}',${idx},'dislike')">
              üëé (<span id="dislikeCount">${v.reactions?.dislike||0}</span>)
            </button>
          </div>
          <div id="adContainer"></div>
        </div>
      `;

      const player=document.getElementById("videoPlayer");
      let ads={start:false,mid:false,end:false};

      player.addEventListener("play",()=>{
        if(!ads.start){ ads.start=true; injectBottomBanner("adContainer"); }
      });
      player.addEventListener("timeupdate",()=>{
        if(player.currentTime>=50 && !ads.mid){ ads.mid=true; injectBottomBanner("adContainer"); }
      });
      player.addEventListener("ended",()=>{
        if(!ads.end){ ads.end=true; injectBottomBanner("adContainer"); }
      });
    }

    // Reacciones
    async function toggleReaction(folder, idx, type){
      const ref = db.collection("folders").doc(folder);
      const snap = await ref.get();
      if(!snap.exists) return;

      const data = snap.data();
      const v = data.videos[idx];

      v.reactions = v.reactions || {like:0, dislike:0};
      v.userReaction = v.userReaction || null;

      if(v.userReaction === type){
        v.reactions[type] = Math.max(0, v.reactions[type]-1);
        v.userReaction = null;
      } else {
        if(v.userReaction){ v.reactions[v.userReaction]--; }
        v.reactions[type]++;
        v.userReaction = type;
      }

      data.videos[idx] = v;
      await ref.update({videos:data.videos});

      document.getElementById("likeCount").textContent = v.reactions.like;
      document.getElementById("dislikeCount").textContent = v.reactions.dislike;

      document.getElementById("likeBtn").classList.toggle("active", v.userReaction==='like');
      document.getElementById("dislikeBtn").classList.toggle("active", v.userReaction==='dislike');
    }

    function injectBottomBanner(containerId){
      const container=document.getElementById(containerId);
      if(!container) return;
      container.innerHTML="";
      const s1=document.createElement("script");
      s1.type="text/javascript";
      s1.text=`
        atOptions = {
          'key' : 'de13ddc2442e4144561bcec2fa1af174',
          'format' : 'iframe',
          'height' : 50,
          'width' : 320,
          'params' : {}
        };
      `;
      const s2=document.createElement("script");
      s2.type="text/javascript";
      s2.src="//leaklitre.com/de13ddc2442e4144561bcec2fa1af174/invoke.js";
      container.appendChild(s1);
      container.appendChild(s2);
    }

    function goHome(){db.collection("folders").get().then(s=>renderHome(s.docs));}

    window.openFolder=openFolder; 
    window.playVideo=playVideo; 
    window.goHome=goHome;

    db.collection("folders").onSnapshot(s=>{
      renderHome(s.docs); 
      renderPreviews(s.docs);
    });

    function renderPreviews(docs){
      let previews = [];
      docs.forEach(doc=>{
        const data = doc.data(); 
        const videos = data.videos||[];
        if(videos.length>0){
          const randomIndex = Math.floor(Math.random()*videos.length);
          previews.push({folder:doc.id, url:videos[randomIndex].url});
        }
      });
      previewList.innerHTML = previews.map(p=>`
        <div class="preview-item" onclick="playVideo('${p.folder}', 0)">
          <video src="${p.url}" muted playsinline></video>
          <div class="preview-title">${p.folder}</div>
        </div>
      `).join("");
    }
  });
</script>
</body>
</html>
